<!-- Import Polymer -->
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/polymer-ui-toggle-button/polymer-ui-toggle-button.html">

<polymer-element name="poly-drop">
	<script src="upload.js"></script>
	<style>
		#dropzone {
			border: 2px dashed #bbb;
			-moz-border-radius: 5px;
			-webkit-border-radius: 5px;
			border-radius: 5px;
			padding: 70px 10px;
			text-align: center;
			font: 20pt bold 'Helvetica';
			color: #bbb;
			background: white;
		}

		#files {
			display: block;
			margin: 0 auto;
		}

		.custom-file-input::-webkit-file-upload-button {
		  visibility: hidden;
		}
		.custom-file-input::before {
			content: 'or click to select files';
			display: inline-block;
			background: rgb(238, 238, 238) !important;
			padding: 5px;
			outline: none;
			white-space: nowrap;
			-webkit-user-select: none;
			cursor: pointer;
			font-size: 16pt;
			width: 250px;
			margin: 0 auto;
		}
		.custom-file-input:hover::before {
		  border-color: black;
		}
		.custom-file-input:active::before {
		  background: -webkit-linear-gradient(top, #e3e3e3, #f9f9f9);
		}

		.filelist ul { padding-left: 0px; list-style-type:none;}
		.filelist li {
			background: #F5F5F5;
			padding: 10px 10px;
			border: 1px solid #ccc
		}

		#toolbar { 
			height: 50px; 
			background: rgb(238, 238, 238) !important; 
			right:0; 
			list-style-type: none;
			display: flex;
			align-items: flex-end;
		}

		#toolbar li {
			float: left;
			margin: 15px;
		}

		#uploadView { display: none; }
	</style>
	<template>
		<span id="signin"></span>

		<div id="uploadView">
			<div id="dropzone" on-click="{{tapSelect}}" on-dragover="{{handleDragOver}}" on-drop="{{handleFileSelect}}">Drag and drop files to upload to Drive<input tabindex="0" type="file" id="files" class="custom-file-input" name="files[]" multiple on-change="{{handleFilePick}}"/> </div>

			<ul id="toolbar">

				<li><div id="status">Waiting for an upload.</div></li>

				<li>Auto-upload: <polymer-ui-toggle-button class="wide-button" onCaption="On" offCaption="Off" value="{{autoUpload}}"></polymer-ui-toggle-button></li>

				<li><button on-click="{{manualUpload}}" style="display:{{ autoUpload ? 'none' : 'block' }}">Upload files</button></li>

			</ul>

			<!-- Files you have added -->
			<h2>Upload queue</h2>
			<ul class="filelist">
				<template repeat="{{file in uploadList}}">
		          <li><strong>{{file.name}}</strong> ({{file.size}}, {{file.type}})</li>
				</template>
			</ul>

			<!-- Files uploaded -->
			<h2>Uploaded</h2>
			<ul class="filelist">
				<template repeat="{{uploadedList}}">
					<li><img src="{{iconLink}}"/> <strong>{{title}}</strong> <a href="{{selfLink}}">Link to file</a>, <a href="{{webContentLink}}">Link to web content</a>, <a href="{{thumbnailLink}}">Thumbnail</a></li>
				</template>
			</ul>

		</div>

	</template>
	<script>
	    var clientId = "400542164111-q94vcbin3jp3fb2a0su1nm6gt4qpf86t.apps.googleusercontent.com";
		var accessToken = null;

		function signinCallback( result ) {
		    if (result.access_token) {
		        accessToken = result.access_token;
		        document.getElementById("___signin_0").style.display = "none";
		        document.getElementById("uploadView").style.display = "block";
		    }
		}

		Polymer('poly-drop', {
			uploadList: [],
			uploadedList: [],
			autoUpload: true,
		    created: function () {
		        var script = document.createElement("script");
		        var body = document.body;
		        var div = document.createElement("div");

		        script.setAttribute("type", "text/javascript");
		        script.setAttribute("src", "https://apis.google.com/js/client:plusone.js");
		        script.setAttribute("async", true);
		        script.innerHTML = "{lang: 'en-us'}";

		        div.setAttribute("class", "g-signin");
		        div.setAttribute("data-callback", "signinCallback");
		        div.setAttribute("data-clientid", clientId);
		        div.setAttribute("data-cookiepolicy", "single_host_origin");
		        div.setAttribute("data-scope", "https://www.googleapis.com/auth/drive.file");
		        body.appendChild(div);
		        body.appendChild(script);

		    },
		    selectFiles: function( files ){
		    	this.queue = files;
		    	this.$.status.innerHTML = 'Files selected';

	        	for ( var i = 0, f; f = files[i]; i++ ) {
	        		this.uploadList.push( f );
	        	}	

		    	if ( this.autoUpload ){
		    		this.uploadFiles( files );
		    	}
		    },
		    manualUpload: function (){
		    	this.uploadFiles( this.queue );
		    },
		    uploadFiles: function ( files ){
		    	var uploadedList = this.uploadedList;

		        for ( var i = 0, f; f = files[i]; i++ ) {
		        	this.$.status.innerHTML = 'Uploading...';
		            var uploader = new MediaUploader({
		                file: f,
		                token: accessToken,
		                onComplete: function (data) {
		                	console.log(data);
		                	uploadedList.push(JSON.parse(data));
		                	this.$.status.innerHTML = 'Upload successful'; 
		                }.bind( this )
		            });
		            uploader.upload();
		        } 		    	
		    },
		    tapSelect: function () {
                this.$.files.click();
		    },
		    handleDragOver: function ( evt ) {
		        evt.stopPropagation();
		        evt.preventDefault();
		        evt.dataTransfer.dropEffect = 'copy';
		    },
		    handleFilePick: function ( evt ) {
		        evt.stopPropagation();
		        evt.preventDefault();
		        this.selectFiles(evt.target.files);		    	
		    },
		    handleFileSelect: function ( evt ) {
		        evt.stopPropagation();
		        evt.preventDefault();
		        this.selectFiles(evt.dataTransfer.files);
		    }
		});
	</script>
</polymer-element>